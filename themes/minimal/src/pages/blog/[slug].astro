---
import path from "path";
import { getAllBlogPosts, getBlogPost } from "@local/content";
import { MarkdocRenderer } from "@local/markdoc-renderer";
import { SITE_TITLE } from "../../config";

import BlogPostMeta from "../../components/BlogPostMeta.astro";
import BlogLayout from "../../layouts/BlogPost.astro";

export async function getStaticPaths() {
  const absolutePathToRepoRoot = path.join(process.cwd(), "..", "..");
  const { type, items } = await getAllBlogPosts({
    absolutePathToRepoRoot,
  });

  return items.map((post) => {
    return { params: { slug: post.slug } };
  });
}

const { slug } = Astro.params;
// TODO type guard slug

const absolutePathToRepoRoot = path.join(process.cwd(), "..", "..");
const post = await getBlogPost({
  absolutePathToRepoRoot,
  filename: slug as string,
});
---

<BlogLayout
  content={{
    // TODO:
    title: post.frontmatter.title,
    date: post.frontmatter.date.toISOString(),
  }}
>
  <BlogPostMeta
    title={post.frontmatter.title}
    description={post.frontmatter.isExternal
      ? undefined
      : post.frontmatter.description}
    publishDate={post.frontmatter.date.toISOString()}
    slot="head"
  />
  <MarkdocRenderer content={post.content} />
</BlogLayout>
